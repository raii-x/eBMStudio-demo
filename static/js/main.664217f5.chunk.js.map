{"version":3,"sources":["icons/tool_select.png","icons/tool_write.png","icons/tool_paint.png","icons/tool_erase.png","icons/tool_keyInput.png","icons/tool_stairs.png","icons/tool_monoStairs.png","icons/tool_trill.png","icons/tool_pattern.png","components/lane.ts","store/types.ts","store/EditContainer.ts","components/CursorNote.tsx","components/LaneComponent.tsx","components/NoteComponent.tsx","components/Notes.tsx","components/HorizontalGrids.tsx","store/SequenceContainer.ts","components/Sequence.tsx","components/ToolBar.tsx","serviceWorker.ts","index.tsx","components/App.tsx"],"names":["module","exports","GRID_MEASURE_LEN","NUM_MEASURE","NOTE_HEIGHT","SNAP_DISTANCE","ZOOM_STEP","GRID_EDIT_DIV","LANE_WIDTH","NUM_BGM_LANES","keyLaneInfo","KEY_LANE_CLASSES","lanes","left","i","length","push","className","width","index","trackLaneInfo","lastLaneInfo","keyLaneToX","lane","xToKeyLane","x","Math","floor","trackLaneToX","xToTrackLane","timePosToY","timePos","zoom","ceil","math","yToTimePos","y","fraction","trackHue","Tool","trackNames","EditContainer","createContainer","_useState","useState","_useState2","Object","slicedToArray","selectedTrack","setSelectedTrack","_useState3","types","Paint","_useState4","selectedTool","setSelectedTool","_useState5","_useState6","verticalZoom","setVerticalZoom","CursorNote","props","useContainer","position","isKey","track","react_default","a","createElement","style","top","LaneComponent","memo","_React$useState","React","_React$useState2","hover","setHover","h","v","selected","classNames","onMouseOver","onMouseOut","backgroundColor","concat","NoteComponent","note","trackSelected","Notes","notes","filter","panelScrollY","panelHeight","map","key","id","HorizontalGrids","toConsumableArray","Array","_","pos","toString","jsonToSequence","json","keyNotes","n","objectSpread","d","nextKeyNoteId","trackNotesList","nts","trackNextIds","SequenceContainer","edit","jsonSeq","fumen","setKeyNotes","setNextKeyNoteId","setTrackNotesList","_useState7","_useState8","setTrackNextIds","_useState9","_useState10","backupKeyNotes","setBackupKeyNotes","reduceAddKeyNotes","source","timePosList","some","t","reduceAddKeyNotesLane","addNotes","addKeyNotes","_reduceAddKeyNotes","_reduceAddKeyNotes2","deleteKeyNotes","ids","includes","addTrackNotes","j","deleteTrackNotes","clearAll","fill","clearKey","addKeyNotesRange","from","to","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","Symbol","iterator","next","done","value","err","return","deleteKeyNotesRange","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","addTrackNotesRange","deleteTrackNotesRange","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","startApplyTool","_reduceAddKeyNotes3","_reduceAddKeyNotes4","newKeyNotes","newId","sort","b","applyStairs","startLane","direction","trackNotes","reverse","_ref2","_iteratorNormalCompletion5","_didIteratorError5","_iteratorError5","_step5","_iterator5","_reduceAddKeyNotesLan3","_reduceAddKeyNotesLan4","applyMonoStairs","_ref3","_iteratorNormalCompletion6","_didIteratorError6","_iteratorError6","_step6","_iterator6","_reduceAddKeyNotesLan5","_reduceAddKeyNotesLan6","applyTrill","_ref","count","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","_reduceAddKeyNotesLan","_reduceAddKeyNotesLan2","computeNearestNote","nearest","nearestDist","abs","dist","KEYCODE_CTRL","Sequence","_SequenceContainer$us","height","panelSize","setPanelSize","scroll","setScroll","ctrlPressed","setCtrlPressed","mousePosition","setMousePosition","mouseButtons","setMouseButtons","_useState11","_useState12","applyingTool","setApplyingTool","panel","useRef","cursorPos","trackLane","multiply","divide","ret","_ret","handleDrag","buttons","newMousePosition","newScroll","startX","Stairs","MonoStairs","Trill","keyLane","ret1","ret2","_ret2","note1","dist1","_ret3","note2","dist2","_sort","_sort2","_sort3","_sort4","useEffect","current","scrollTo","scrollHeight","handleResize","cur","clientWidth","clientHeight","window","addEventListener","removeEventListener","handleKeyDown","e","keyCode","handleKeyUp","handleMouseDown","handleMouseUp","handleCopy","clipboardData","setData","JSON","stringify","preventDefault","handlePaste","parse","getData","_jsonToSequence","console","error","document","ref","onScroll","currentTarget","scrollLeft","scrollTop","onWheel","shiftKey","deltaY","NUM_TRACKS","ctrlKey","onMouseDown","rect","getBoundingClientRect","clientX","button","tool","isModalTool","onMouseUp","onMouseMove","stopPropagation","clientY","assign","CursorNote_CursorNote","icons","enabled","icon","iconSelect","label","iconWrite","iconPaint","iconErase","iconKeyInput","iconStairs","iconMonoStairs","iconTrill","iconPattern","KEYCODE_1","ToolBar","Pattern","vz","onClick","src","alt","createTool","type","min","max","step","onChange","Number","parseFloat","Boolean","location","hostname","match","ReactDOM","render","Provider","onContextMenu","onDragStart","ToolBar_ToolBar","getElementById","navigator","serviceWorker","ready","then","registration","unregister"],"mappings":"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","file":"static/js/main.664217f5.chunk.js","sourcesContent":["module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAAC9JREFUGJWNzrEJAEAMw0Br/6U/tVDxLo8QtN2YhgULFixYsGCJH0ohUj5q62S5ByKiADstOZhmAAAAAElFTkSuQmCC\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAACpJREFUGJVjYGRkQAWMYIAqAiKQBeCiSAIouhgxzGGEATqK4PcUus/BfAAzBgBlSQA9VgAAAABJRU5ErkJggg==\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAAC5JREFUGJVjYGBgYARhRiiDAcJhZAQTcAEYoKIAJsBUgKkBwwAiBBA+wyUA1wIAPeQAYY20mNcAAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAADhJREFUGJV1z7ENADAIA0H//kuniYAnigskXwMkv8DuFrCABSxgefqg20tSkLmjpI8Ys8WfrLucAzRqAGAAceC+AAAAAElFTkSuQmCC\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAACZJREFUGJVjYCAGMMEBTAAsCGWQK4BiKCMqAAqABeEEeQLohhIEAEexAH90LjPrAAAAAElFTkSuQmCC\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAABpJREFUGJVjYMABGKGAEgFUwAQFlAjQ2o0MAEUQAIEDwOg0AAAAAElFTkSuQmCC\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAABVJREFUGJVjYMANGMGAMoGhZB4IAAAnUABJQ4iyDwAAAABJRU5ErkJggg==\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAABlJREFUGJVjYIACRjBgQABSBCjSjAoG2B0ANEAAYTosQ+4AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAAXNSR0IArs4c6QAAAAlQTFRFAAAA////dn7/vwQsZgAAAAN0Uk5TAP//RFDWIQAAADtJREFUGJVjYAABRhBgQAJkCGADTCAAU40mAMQoAlBBZAE0KxgZYZai0IyMSK6BiSCchyGAbizUYggAAEA+AIEMev2kAAAAAElFTkSuQmCC\"","import { fraction, Fraction } from 'mathjs';\r\nimport * as math from \"mathjs\";\r\n\r\nexport const GRID_MEASURE_LEN = 192;\r\nexport const NUM_MEASURE = 16;\r\n\r\nexport const NOTE_HEIGHT = 10;\r\nexport const SNAP_DISTANCE = 96;\r\nexport const PRELOAD_LEN = 0.25;\r\nexport const ZOOM_STEP = 0.25;\r\n\r\nexport const GRID_EDIT_DIV = 16;\r\nexport const GRID_SUB_DIV = 4;\r\n\r\nexport const LANE_WIDTH = 28;\r\nexport const LANE_SEPARATER_WIDTH = 50; //4;\r\nexport const LANE_LEFT = 35;\r\n\r\nexport const NUM_KEY_LANES = 8;\r\nexport const NUM_BGM_LANES = 16; // TODO: Stateに入れる\r\n\r\ninterface LaneInfo {\r\n  className: string,\r\n  left: number,\r\n  width: number,\r\n  index: number\r\n}\r\n\r\nexport const keyLaneInfo: LaneInfo[] = (() => {\r\n  const KEY_LANE_CLASSES = [\r\n    'lane-sc',\r\n    'lane-w',\r\n    'lane-b',\r\n    'lane-w',\r\n    'lane-b',\r\n    'lane-w',\r\n    'lane-b',\r\n    'lane-w',\r\n  ];\r\n\r\n  let lanes = [] as LaneInfo[];\r\n  let left = LANE_LEFT;\r\n\r\n  for (let i = 0; i < KEY_LANE_CLASSES.length; i++) {\r\n    lanes.push({ className: KEY_LANE_CLASSES[i], left, width: LANE_WIDTH, index: i });\r\n    left += LANE_WIDTH;\r\n  }\r\n\r\n  return lanes;\r\n})();\r\n\r\nexport const trackLaneInfo: LaneInfo[] = (() => {\r\n  let lanes = [] as LaneInfo[];\r\n\r\n  const lastLaneInfo = keyLaneInfo[keyLaneInfo.length - 1];\r\n  let left = lastLaneInfo.left + lastLaneInfo.width;\r\n\r\n  left += LANE_SEPARATER_WIDTH;\r\n\r\n  for (let i = 0; i < NUM_BGM_LANES; i++) {\r\n    lanes.push({ className: 'lane-track', left, width: LANE_WIDTH, index: i });\r\n    left += LANE_WIDTH;\r\n  }\r\n\r\n  return lanes;\r\n})();\r\n\r\nexport function keyLaneToX(lane: number): number {\r\n  return keyLaneInfo[0].left + lane * LANE_WIDTH + 1;\r\n}\r\n\r\nexport function xToKeyLane(x: number): number | null {\r\n  const lane = Math.floor((x - keyLaneInfo[0].left) / LANE_WIDTH);\r\n  if (lane < 0 || lane >= keyLaneInfo.length) return null;\r\n  return lane;\r\n}\r\n\r\nexport function trackLaneToX(lane: number): number {\r\n  return trackLaneInfo[0].left + lane * LANE_WIDTH + 1;\r\n}\r\n\r\nexport function xToTrackLane(x: number): number | null {\r\n  const lane = Math.floor((x - trackLaneInfo[0].left) / LANE_WIDTH);\r\n  if (lane < 0 || lane >= trackLaneInfo.length) return null;\r\n  return lane;\r\n}\r\n\r\nexport function timePosToY(timePos: Fraction, zoom: number): number {\r\n  return Math.ceil(GRID_MEASURE_LEN * (NUM_MEASURE - (math.number(timePos) as number)) * zoom);\r\n}\r\n\r\nexport function yToTimePos(y: number, zoom: number): Fraction {\r\n  const timePos = math.subtract(NUM_MEASURE, fraction(y / zoom, GRID_MEASURE_LEN)) as Fraction;\r\n  if (math.smaller(timePos, 0)) return fraction(0) as Fraction;\r\n  return timePos;\r\n}\r\n\r\nexport function trackHue(i: number) {\r\n  return i * 360 / NUM_BGM_LANES;\r\n}\r\n\r\nexport const trackNames = [\r\n  'BD',\r\n  'CP',\r\n  'SD',\r\n  'HH',\r\n  'RD',\r\n  'CY',\r\n  'Break',\r\n  'Fill',\r\n  'Lead',\r\n  'Bell',\r\n  'Piano',\r\n  'Arp',\r\n  'Chord',\r\n  'Bass',\r\n  'Pad',\r\n  'Fx'\r\n];\r\n","import { Fraction } from 'mathjs';\r\n\r\nexport enum Tool {\r\n  Select,\r\n  Write,\r\n  Paint,\r\n  Erase,\r\n  KeyInput,\r\n  Stairs,\r\n  MonoStairs,\r\n  Trill,\r\n  Pattern,\r\n};\r\n\r\nexport type KeyNote = {\r\n  isKey: true,\r\n  id: number,\r\n  track: number, // TODO: nullを含める\r\n  timePos: Fraction,\r\n  lane: number\r\n};\r\n\r\nexport type TrackNote = {\r\n  isKey: false,\r\n  id: number,\r\n  track: number,\r\n  timePos: Fraction,\r\n};\r\n\r\nexport type Note = KeyNote | TrackNote;\r\n\r\nexport type CursorKeyNotePosition = {\r\n  isKey: true,\r\n  lane: number,\r\n  timePos: Fraction,\r\n  note: KeyNote | null\r\n};\r\n\r\nexport type CursorTrackNotePosition = {\r\n  isKey: false,\r\n  track: number,\r\n  timePos: Fraction,\r\n  note: TrackNote | null\r\n};\r\n\r\nexport type CursorNotePosition = CursorKeyNotePosition | CursorTrackNotePosition;\r\n","import { createContainer } from 'unstated-next';\r\nimport * as types from './types';\r\nimport { useState } from 'react';\r\n\r\nexport const EditContainer = createContainer(() => {\r\n  const [selectedTrack, setSelectedTrack] = useState(0);\r\n  const [selectedTool, setSelectedTool] = useState(types.Tool.Paint);\r\n  const [verticalZoom, setVerticalZoom] = useState(2);\r\n\r\n  return {\r\n    selectedTrack, setSelectedTrack,\r\n    selectedTool, setSelectedTool,\r\n    verticalZoom, setVerticalZoom\r\n  };\r\n});\r\n","import React from 'react';\r\nimport { keyLaneToX, timePosToY, trackLaneToX } from './lane';\r\nimport { EditContainer } from '../store/EditContainer';\r\nimport { CursorNotePosition } from '../store/types';\r\n\r\ninterface Props {\r\n  position: CursorNotePosition;\r\n}\r\n\r\nexport const CursorNote: React.FC<Props> = props => {\r\n  const { verticalZoom } = EditContainer.useContainer();\r\n  const x = props.position.isKey ? keyLaneToX(props.position.lane) : trackLaneToX(props.position.track);\r\n\r\n  return (\r\n    <div className=\"CursorNote\"\r\n      style={{\r\n        left: x,\r\n        top: timePosToY(props.position.timePos, verticalZoom)\r\n      }}\r\n    >\r\n    </div>\r\n  );\r\n};\r\n","import React, { memo } from 'react';\r\nimport classNames from 'classnames';\r\nimport { trackHue, trackNames } from './lane';\r\n\r\ninterface LaneProps {\r\n  index: number,\r\n  className: string,\r\n  left: number,\r\n  width: number,\r\n  selected: boolean\r\n}\r\n\r\nexport const LaneComponent: React.FC<LaneProps> = memo(props => {\r\n  const [hover, setHover] = React.useState(false);\r\n  const h = trackHue(props.index);\r\n  const v = props.selected ? 29 : hover ? 18 : 7;\r\n\r\n  return (\r\n    <div className=\"LaneComponent\"\r\n      style={{\r\n        left: props.left,\r\n        width: props.width\r\n      }}\r\n    >\r\n      <div className={\r\n        classNames('lane', props.className, props.selected && 'selected')}\r\n        onMouseOver={() => setHover(true)}\r\n        onMouseOut={() => setHover(false)}\r\n        style={\r\n          props.className === 'lane-track' ?\r\n            { backgroundColor: `hsl(${h}, 52%, ${v}%)` } :\r\n            {}\r\n        }\r\n      >\r\n      </div>\r\n      <div className=\"grid-v\"></div>\r\n      <div className={classNames('lane-label', props.selected && 'selected')}>\r\n        {props.className === 'lane-track' ? trackNames[props.index] : ''}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n","import React, { memo } from 'react';\r\nimport { Note } from '../store/types';\r\nimport { keyLaneToX, trackLaneToX, timePosToY, trackHue, trackNames } from './lane';\r\nimport { EditContainer } from '../store/EditContainer';\r\nimport classNames from 'classnames';\r\n\r\ninterface Props {\r\n  note: Note;\r\n  trackSelected: boolean;\r\n}\r\n\r\nexport const NoteComponent: React.FC<Props> = memo(props => {\r\n  const { verticalZoom } = EditContainer.useContainer();\r\n\r\n  return (\r\n    <div className=\"NoteComponent\"\r\n      style={{\r\n        left: props.note.isKey ? keyLaneToX(props.note.lane) : trackLaneToX(props.note.track),\r\n        top: timePosToY(props.note.timePos, verticalZoom),\r\n        backgroundColor: `hsl(${trackHue(props.note.track)}, ${props.trackSelected ? '100%, 60%' : '70%, 30%'})`,\r\n      }}\r\n    >\r\n      <div className={classNames('text', props.trackSelected && 'selected')}>\r\n        {trackNames[props.note.track]}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n","import React, { memo } from 'react';\r\nimport { Note } from \"../store/types\";\r\nimport { NoteComponent } from \"./NoteComponent\";\r\nimport { timePosToY, PRELOAD_LEN } from './lane';\r\nimport { EditContainer } from '../store/EditContainer';\r\n\r\ninterface Props {\r\n  notes: Note[];\r\n  selectedTrack: number;\r\n  panelScrollY: number;\r\n  panelHeight: number;\r\n}\r\n\r\nexport const Notes: React.FC<Props> = memo(props => {\r\n  const { verticalZoom } = EditContainer.useContainer();\r\n  return (\r\n    <div>\r\n      {props.notes.filter(note => {\r\n        const y = timePosToY(note.timePos, verticalZoom);\r\n        return props.panelScrollY - props.panelHeight * PRELOAD_LEN < y &&\r\n          y <= props.panelScrollY + props.panelHeight * (1 + PRELOAD_LEN);\r\n      }).map(note =>\r\n        <NoteComponent\r\n          key={note.id}\r\n          note={note}\r\n          trackSelected={note.track === props.selectedTrack}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n});\r\n","import React, { memo } from 'react';\r\nimport { timePosToY, NUM_MEASURE, GRID_EDIT_DIV, GRID_SUB_DIV, PRELOAD_LEN } from './lane';\r\nimport { EditContainer } from '../store/EditContainer';\r\nimport { fraction, Fraction } from 'mathjs';\r\nimport classNames from 'classnames';\r\nimport * as math from 'mathjs';\r\n\r\ninterface Props {\r\n  panelScrollY: number;\r\n  panelHeight: number;\r\n}\r\n\r\nexport const HorizontalGrids: React.FC<Props> = memo(props => {\r\n  const { verticalZoom } = EditContainer.useContainer();\r\n  return (\r\n    <div>\r\n      {[...Array(NUM_MEASURE * GRID_EDIT_DIV)]\r\n        .map((_, i) => fraction(i, GRID_EDIT_DIV) as Fraction)\r\n        .filter(pos => {\r\n          const y = timePosToY(pos, verticalZoom);\r\n          return props.panelScrollY - props.panelHeight * PRELOAD_LEN < y &&\r\n            y - 1 < props.panelScrollY + props.panelHeight * (1 + PRELOAD_LEN);\r\n        })\r\n        .map(pos =>\r\n          <div\r\n            key={pos.toString()}\r\n            className={classNames('grid-h',\r\n              math.equal(math.mod(pos, 1), 0) ? 'grid-measure' :\r\n                math.equal(math.mod(math.multiply(pos, GRID_EDIT_DIV) as Fraction, GRID_SUB_DIV), 0) ? 'grid-sub' :\r\n                  'grid-edit'\r\n            )}\r\n            style={{ top: timePosToY(pos, verticalZoom) - 1 }}>\r\n          </div>\r\n        )}\r\n    </div>\r\n  );\r\n});\r\n","import { useState } from 'react';\r\nimport { createContainer } from 'unstated-next';\r\nimport { Fraction, fraction } from 'mathjs';\r\nimport * as types from './types'\r\nimport { NUM_BGM_LANES, GRID_EDIT_DIV } from '../components/lane';\r\nimport { EditContainer } from './EditContainer';\r\nimport * as math from 'mathjs';\r\nimport fumen from '../fumen.json';\r\n\r\nexport const jsonToSequence = (json: any) => ({\r\n  keyNotes: json.keyNotes.map((n: any) => ({\r\n    ...n,\r\n    timePos: fraction(n.timePos.n, n.timePos.d) as Fraction\r\n  })) as types.KeyNote[],\r\n  nextKeyNoteId: json.nextKeyNoteId as number,\r\n  trackNotesList: json.trackNotesList.map((nts: any) => nts.map((n: any) => ({\r\n    ...n,\r\n    timePos: fraction(n.timePos.n, n.timePos.d) as Fraction\r\n  }))) as types.TrackNote[][],\r\n  trackNextIds: json.trackNextIds as number[]\r\n});\r\n\r\nexport const SequenceContainer = createContainer(() => {\r\n  const edit = EditContainer.useContainer();\r\n\r\n  // const [keyNotes, setKeyNotes] = useState([] as types.KeyNote[]);\r\n  // const [nextKeyNoteId, setNextKeyNoteId] = useState(0);\r\n  // const [trackNotesList, setTrackNotesList] = useState<types.TrackNote[][]>(Array(NUM_BGM_LANES).fill([]));\r\n  // const [trackNextIds, setTrackNextIds] = useState<number[]>(Array(NUM_BGM_LANES).fill(0));\r\n  const jsonSeq = jsonToSequence(fumen);\r\n  const [keyNotes, setKeyNotes] = useState(jsonSeq.keyNotes);\r\n  const [nextKeyNoteId, setNextKeyNoteId] = useState(jsonSeq.nextKeyNoteId);\r\n  const [trackNotesList, setTrackNotesList] = useState(jsonSeq.trackNotesList);\r\n  const [trackNextIds, setTrackNextIds] = useState(jsonSeq.trackNextIds);\r\n  const [backupKeyNotes, setBackupKeyNotes] = useState([] as types.KeyNote[]);\r\n\r\n  // TODO: トラックの削除の際に選択トラックがそのトラックなら選択トラックを変える\r\n\r\n  // アクション\r\n\r\n  const clearAll = () => {\r\n    setKeyNotes([]);\r\n    setNextKeyNoteId(0);\r\n    setTrackNotesList(Array(NUM_BGM_LANES).fill([]));\r\n    setTrackNextIds(Array(NUM_BGM_LANES).fill(0));\r\n  }\r\n\r\n  const clearKey = () => {\r\n    setKeyNotes([]);\r\n    setNextKeyNoteId(0);\r\n  }\r\n\r\n  const reduceAddKeyNotes = (source: types.KeyNote[], track: number, timePosList: Fraction[], lane: number)\r\n    : [types.KeyNote[], number] => [\r\n      source.filter(n => n.track !== track || !timePosList.some(t => math.equal(t, n.timePos))).concat(\r\n        timePosList.map((timePos, i) => ({\r\n          isKey: true,\r\n          id: nextKeyNoteId + i,\r\n          track,\r\n          timePos,\r\n          lane,\r\n        }))\r\n      ),\r\n      nextKeyNoteId + timePosList.length\r\n    ];\r\n\r\n  const reduceAddKeyNotesLane = (source: types.KeyNote[], track: number, addNotes: { timePos: Fraction, lane: number }[])\r\n    : [types.KeyNote[], number] => [\r\n      source.filter(n => n.track !== track || !addNotes.some(a => math.equal(a.timePos, n.timePos))).concat(\r\n        addNotes.map((note, i) => ({\r\n          isKey: true,\r\n          id: nextKeyNoteId + i,\r\n          track,\r\n          timePos: note.timePos,\r\n          lane: note.lane,\r\n        }))\r\n      ),\r\n      nextKeyNoteId + addNotes.length\r\n    ];\r\n\r\n  const addKeyNotes = (track: number, timePosList: Fraction[], lane: number) => {\r\n    const [notes, id] = reduceAddKeyNotes(keyNotes, track, timePosList, lane);\r\n    setKeyNotes(notes);\r\n    setNextKeyNoteId(id);\r\n  };\r\n\r\n  const addKeyNotesRange = (track: number, from: Fraction, to: Fraction, lane: number) => {\r\n    const timePosList = [];\r\n\r\n    for (const note of trackNotesList[track]) {\r\n      if (math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        timePosList.push(note.timePos);\r\n      }\r\n    }\r\n\r\n    addKeyNotes(track, timePosList, lane);\r\n  };\r\n\r\n  const deleteKeyNotes = (ids: number[]) =>\r\n    setKeyNotes(\r\n      keyNotes.filter(note => !ids.includes(note.id))\r\n    );\r\n\r\n  const deleteKeyNotesRange = (track: number, from: Fraction, to: Fraction, lane: number) => {\r\n    const ids = [];\r\n\r\n    for (const note of keyNotes) {\r\n      if (note.lane === lane && note.track === track && math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        ids.push(note.id);\r\n      }\r\n    }\r\n\r\n    deleteKeyNotes(ids);\r\n  };\r\n\r\n  const addTrackNotes = (track: number, timePosList: Fraction[]) => {\r\n    setTrackNotesList(\r\n      trackNotesList.map((notes, i) =>\r\n        i === track ?\r\n          notes.filter(n => !timePosList.some(t => math.equal(t, n.timePos))).concat(\r\n            timePosList.map((timePos, j) => ({\r\n              isKey: false,\r\n              id: trackNextIds[i] + j,\r\n              track,\r\n              timePos,\r\n            }))\r\n          ) :\r\n          notes\r\n      )\r\n    );\r\n    setTrackNextIds(trackNextIds.map((id, i) =>\r\n      i === track ? id + trackNextIds.length : id\r\n    ));\r\n  };\r\n\r\n  const addTrackNotesRange = (track: number, from: Fraction, to: Fraction) => {\r\n    const timePosList = [];\r\n\r\n    for (let pos = from; math.smallerEq(pos, to); pos = math.add(pos, fraction(1, GRID_EDIT_DIV)) as Fraction) {\r\n      timePosList.push(pos);\r\n    }\r\n\r\n    addTrackNotes(track, timePosList);\r\n  };\r\n\r\n  const deleteTrackNotes = (track: number, ids: number[]) =>\r\n    setTrackNotesList(trackNotesList.map((notes, i) =>\r\n      i === track ?\r\n        notes.filter(note =>\r\n          !ids.includes(note.id)\r\n        ) :\r\n        notes\r\n    ));\r\n\r\n  const deleteTrackNotesRange = (track: number, from: Fraction, to: Fraction) => {\r\n    const ids = [];\r\n\r\n    for (const note of trackNotesList[track]) {\r\n      if (math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        ids.push(note.id);\r\n      }\r\n    }\r\n\r\n    deleteTrackNotes(track, ids);\r\n  };\r\n\r\n  const startApplyTool = (track: number, timePos: Fraction, lane: number) => {\r\n    setBackupKeyNotes(keyNotes);\r\n    const [newKeyNotes, newId] = reduceAddKeyNotes(keyNotes, track, [timePos], lane);\r\n    setKeyNotes(newKeyNotes);\r\n    setNextKeyNoteId(newId);\r\n\r\n    // ツール適用のためにソートする\r\n    setTrackNotesList(trackNotesList.map((notes, i) =>\r\n      i === track ?\r\n        [...notes].sort((a, b) => math.compare(a.timePos, b.timePos) as number) :\r\n        notes\r\n    ));\r\n  };\r\n\r\n  // これは from > to を許容する\r\n  const applyTrill = (track: number, from: Fraction, to: Fraction, lanes: [number, number]) => {\r\n    const addNotes: { timePos: Fraction, lane: number }[] = [];\r\n    let trackNotes = trackNotesList[track];\r\n    if (math.larger(from, to)) {\r\n      trackNotes = [...trackNotesList[track]].reverse();\r\n      [from, to] = [to, from];\r\n    }\r\n    let count = 0;\r\n    for (const note of trackNotes) {\r\n      if (math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        addNotes.push({ timePos: note.timePos, lane: lanes[count % 2] });\r\n        count++;\r\n      }\r\n    }\r\n\r\n    const [notes, id] = reduceAddKeyNotesLane(backupKeyNotes, track, addNotes);\r\n    setKeyNotes(notes);\r\n    setNextKeyNoteId(id);\r\n  }\r\n\r\n  // これは from > to を許容する\r\n  const applyStairs = (track: number, from: Fraction, to: Fraction, startLane: number, direction: number) => {\r\n    const addNotes: { timePos: Fraction, lane: number }[] = [];\r\n    let trackNotes = trackNotesList[track];\r\n    if (math.larger(from, to)) {\r\n      trackNotes = [...trackNotesList[track]].reverse();\r\n      [from, to] = [to, from];\r\n    }\r\n    let lane = startLane;\r\n    for (const note of trackNotes) {\r\n      if (math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        addNotes.push({ timePos: note.timePos, lane });\r\n        if (lane !== 0) {\r\n          if (lane === 1) direction = 1;\r\n          if (lane === 7) direction = -1;\r\n          lane += direction;\r\n        }\r\n      }\r\n    }\r\n\r\n    const [notes, id] = reduceAddKeyNotesLane(backupKeyNotes, track, addNotes);\r\n    setKeyNotes(notes);\r\n    setNextKeyNoteId(id);\r\n  }\r\n\r\n  // これは from > to を許容する\r\n  const applyMonoStairs = (track: number, from: Fraction, to: Fraction, startLane: number, direction: number) => {\r\n    const addNotes: { timePos: Fraction, lane: number }[] = [];\r\n    let trackNotes = trackNotesList[track];\r\n    if (math.larger(from, to)) {\r\n      trackNotes = [...trackNotesList[track]].reverse();\r\n      [from, to] = [to, from];\r\n    }\r\n    let lane = startLane;\r\n    for (const note of trackNotes) {\r\n      if (math.smallerEq(from, note.timePos) && math.smallerEq(note.timePos, to)) {\r\n        addNotes.push({ timePos: note.timePos, lane });\r\n        if (lane !== 0) {\r\n          if (lane % 2 === 0) {\r\n            lane = ((lane / 2 - 1 + 3 + direction) % 3 + 1) * 2;\r\n          } else {\r\n            lane = ((lane - 1) / 2 + 4 + direction) % 4 * 2 + 1;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    const [notes, id] = reduceAddKeyNotesLane(backupKeyNotes, track, addNotes);\r\n    setKeyNotes(notes);\r\n    setNextKeyNoteId(id);\r\n  }\r\n\r\n  return {\r\n    edit,\r\n    keyNotes, setKeyNotes, trackNotesList, setTrackNotesList, clearAll, clearKey,\r\n    nextKeyNoteId, setNextKeyNoteId, trackNextIds, setTrackNextIds,\r\n    addKeyNotes, addKeyNotesRange, deleteKeyNotes, deleteKeyNotesRange,\r\n    addTrackNotes, addTrackNotesRange, deleteTrackNotes, deleteTrackNotesRange,\r\n    startApplyTool, applyStairs, applyMonoStairs, applyTrill,\r\n  };\r\n});\r\n","import React, { useState, useRef, useEffect, memo } from 'react';\r\nimport { CursorNote } from './CursorNote';\r\nimport { GRID_MEASURE_LEN, NUM_MEASURE, timePosToY, LANE_WIDTH, keyLaneInfo, trackLaneInfo, xToKeyLane, xToTrackLane, NUM_BGM_LANES as NUM_TRACKS, SNAP_DISTANCE, NOTE_HEIGHT, ZOOM_STEP, yToTimePos, GRID_EDIT_DIV, keyLaneToX } from './lane';\r\nimport { LaneComponent } from './LaneComponent';\r\nimport { Fraction } from 'mathjs';\r\nimport { Notes } from './Notes';\r\nimport { HorizontalGrids } from './HorizontalGrids';\r\nimport * as math from 'mathjs';\r\nimport { CursorNotePosition, CursorTrackNotePosition, CursorKeyNotePosition, TrackNote, Tool } from '../store/types';\r\nimport { SequenceContainer, jsonToSequence } from '../store/SequenceContainer';\r\n\r\ninterface Point2D {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nfunction isModalTool(tool: Tool) {\r\n  switch (tool) {\r\n    case Tool.Stairs:\r\n    case Tool.MonoStairs:\r\n    case Tool.Trill:\r\n      return true;\r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n// trackNotesのうちの時間位置が最も近いノートを取得して返す\r\nfunction computeNearestNote(trackNotes: TrackNote[], y: number, verticalZoom: number)\r\n  : [TrackNote, number] | null {\r\n\r\n  if (trackNotes.length === 0) return null;\r\n\r\n  let nearest = trackNotes[0];\r\n  let nearestDist = Math.abs(timePosToY(nearest.timePos, verticalZoom) - NOTE_HEIGHT / 2 - (y + 1));\r\n\r\n  for (let i = 1; i < trackNotes.length; i++) {\r\n    const dist = Math.abs(timePosToY(trackNotes[i].timePos, verticalZoom) - NOTE_HEIGHT / 2 - (y + 1));\r\n    if (dist < nearestDist) {\r\n      nearest = trackNotes[i];\r\n      nearestDist = dist;\r\n    }\r\n  }\r\n\r\n  return [nearest, nearestDist];\r\n}\r\n\r\nconst KEYCODE_CTRL = 17;\r\n\r\nexport const Sequence: React.FC = memo(() => {\r\n  const {\r\n    edit,\r\n    keyNotes, setKeyNotes, trackNotesList, setTrackNotesList,\r\n    nextKeyNoteId, setNextKeyNoteId, trackNextIds, setTrackNextIds,\r\n    addKeyNotes, addKeyNotesRange, deleteKeyNotes, deleteKeyNotesRange,\r\n    addTrackNotes, addTrackNotesRange, deleteTrackNotes, deleteTrackNotesRange,\r\n    startApplyTool, applyStairs, applyMonoStairs, applyTrill,\r\n  } = SequenceContainer.useContainer();\r\n\r\n  const [panelSize, setPanelSize] = useState({ width: 0, height: 0 });\r\n  const [scroll, setScroll] = useState({ x: 0, y: 0 } as Point2D);\r\n  const [ctrlPressed, setCtrlPressed] = useState(false);\r\n  const [mousePosition, setMousePosition] = useState<Point2D | null>(null);\r\n  const [mouseButtons, setMouseButtons] = useState(0);\r\n  const [applyingTool, setApplyingTool] = useState<{ timePos: Fraction, lane: number } | null>(null);\r\n\r\n  const panel = useRef<HTMLDivElement>(null);\r\n\r\n  // カーソルノートの位置を計算\r\n  const cursorPos: CursorNotePosition | null = (() => {\r\n    if (!mousePosition) return null;\r\n\r\n    const x = mousePosition.x + scroll.x;\r\n    const y = mousePosition.y + scroll.y;\r\n    const notes = trackNotesList[edit.selectedTrack];\r\n\r\n    if (ctrlPressed) {\r\n      // トラックが対象\r\n      const trackLane = xToTrackLane(x);\r\n      if (trackLane === null) return null;\r\n\r\n      // カーソルと時間位置が等しいかそれ以前のグリッドのうち、最も後ろのものを時間位置とする\r\n      const timePos = math.chain(yToTimePos(y, edit.verticalZoom))\r\n        .multiply(GRID_EDIT_DIV)\r\n        .floor()\r\n        .divide(GRID_EDIT_DIV).done() as Fraction;\r\n\r\n      // カーソルのトラックのうち、時間位置が等しいトラックノートを取得\r\n      let note = null;\r\n      for (const n of trackNotesList[trackLane]) {\r\n        if (math.equal(n.timePos, timePos)) {\r\n          note = n;\r\n          break;\r\n        }\r\n      }\r\n\r\n      return {\r\n        isKey: false,\r\n        track: trackLane,\r\n        timePos,\r\n        note\r\n      } as CursorTrackNotePosition;\r\n\r\n    } else {\r\n      // キーが対象\r\n      const lane = xToKeyLane(x);\r\n      if (lane === null) return null;\r\n\r\n      // カーソルのトラックのうち、最も近いトラックノートを取得\r\n      const ret = computeNearestNote(notes, y, edit.verticalZoom);\r\n      if (!ret) return null;\r\n      const [nearest, nearestDist] = ret;\r\n\r\n      // 最短スナップ距離以下ならそのノートの時間位置にカーソル\r\n      if (nearestDist > SNAP_DISTANCE) return null;\r\n\r\n      // キーノートからレーンとトラックと時間位置が等しいノートを取得\r\n      let note = null;\r\n      for (const n of keyNotes) {\r\n        if (n.lane === lane && n.track === edit.selectedTrack && math.equal(n.timePos, nearest.timePos)) {\r\n          note = n;\r\n          break;\r\n        }\r\n      }\r\n\r\n      return {\r\n        isKey: true,\r\n        lane: lane,\r\n        timePos: nearest.timePos,\r\n        note\r\n      } as CursorKeyNotePosition;\r\n    }\r\n  })();\r\n\r\n  // 初期化時に最下部へスクロール\r\n  useEffect(() => {\r\n    if (panel.current) panel.current.scrollTo(0, panel.current.scrollHeight);\r\n  }, []);\r\n\r\n  //パネルサイズを取得\r\n  useEffect(() => {\r\n    function handleResize() {\r\n      const cur = panel.current;\r\n      if (cur) setPanelSize({ width: cur.clientWidth, height: cur.clientHeight });\r\n    }\r\n    handleResize();\r\n    window.addEventListener('resize', handleResize);\r\n    return () => window.removeEventListener('resize', handleResize);\r\n  }, []);\r\n\r\n  // キーボードイベントを登録\r\n  useEffect(() => {\r\n    function handleKeyDown(e: KeyboardEvent) {\r\n      if (e.keyCode === KEYCODE_CTRL) {\r\n        setCtrlPressed(true);\r\n      }\r\n    }\r\n    function handleKeyUp(e: KeyboardEvent) {\r\n      if (e.keyCode === KEYCODE_CTRL) {\r\n        setCtrlPressed(false);\r\n      }\r\n    }\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    window.addEventListener('keyup', handleKeyUp);\r\n\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n      window.removeEventListener('keyup', handleKeyUp);\r\n    };\r\n  }, [keyNotes, trackNotesList]);\r\n\r\n  // マウスイベントを登録\r\n  useEffect(() => {\r\n    function handleMouseDown(e: MouseEvent) {\r\n      setMouseButtons(e.buttons);\r\n    }\r\n    function handleMouseUp(e: MouseEvent) {\r\n      setMouseButtons(e.buttons);\r\n    }\r\n\r\n    window.addEventListener('mousedown', handleMouseDown);\r\n    window.addEventListener('mouseup', handleMouseUp);\r\n\r\n    return () => {\r\n      window.removeEventListener('mousedown', handleMouseDown);\r\n      window.removeEventListener('mouseup', handleMouseUp);\r\n    };\r\n  }, [mouseButtons]);\r\n\r\n  // クリップボードイベントを登録\r\n  useEffect(() => {\r\n    function handleCopy(e: ClipboardEvent) {\r\n      // 譜面を出力\r\n      if (e.clipboardData) {\r\n        e.clipboardData.setData('text/plain',\r\n          JSON.stringify({ keyNotes, nextKeyNoteId, trackNotesList, trackNextIds }));\r\n      }\r\n      e.preventDefault();\r\n    }\r\n    function handlePaste(e: ClipboardEvent) {\r\n      if (e.clipboardData) {\r\n        try {\r\n          const json = JSON.parse(e.clipboardData.getData('text/plain'));\r\n\r\n          const { keyNotes, nextKeyNoteId, trackNotesList, trackNextIds } = jsonToSequence(json);\r\n          setKeyNotes(keyNotes);\r\n          setNextKeyNoteId(nextKeyNoteId);\r\n          setTrackNotesList(trackNotesList);\r\n          setTrackNextIds(trackNextIds);\r\n\r\n        } catch (e) {\r\n          console.error(e);\r\n        }\r\n      }\r\n      e.preventDefault();\r\n    }\r\n\r\n    document.addEventListener('copy', handleCopy);\r\n    document.addEventListener('paste', handlePaste);\r\n\r\n    return () => {\r\n      document.removeEventListener('copy', handleCopy);\r\n      document.removeEventListener('paste', handlePaste);\r\n    };\r\n  }, [keyNotes, trackNotesList, nextKeyNoteId, setKeyNotes, setNextKeyNoteId, setTrackNextIds, setTrackNotesList, trackNextIds]);\r\n\r\n  function handleScroll(e: React.UIEvent<HTMLDivElement>) {\r\n\r\n    const newScroll = {\r\n      x: e.currentTarget.scrollLeft,\r\n      y: e.currentTarget.scrollTop\r\n    };\r\n    handleDrag(mouseButtons, mousePosition, newScroll);\r\n\r\n    setScroll(newScroll);\r\n  }\r\n\r\n  function handleMouseDown(e: React.MouseEvent<HTMLDivElement, MouseEvent>) {\r\n    const rect = e.currentTarget.getBoundingClientRect();\r\n    const x = e.clientX - rect.left;\r\n\r\n    if (applyingTool) {\r\n      setApplyingTool(null);\r\n      return;\r\n    }\r\n\r\n    if (e.button === 0) { // 左クリック\r\n      if (cursorPos) {\r\n        if (cursorPos.isKey) {\r\n          if (isModalTool(edit.selectedTool)) {\r\n            setApplyingTool({ timePos: cursorPos.timePos, lane: cursorPos.lane });\r\n            startApplyTool(edit.selectedTrack, cursorPos.timePos, cursorPos.lane);\r\n          } else {\r\n            addKeyNotes(edit.selectedTrack, [cursorPos.timePos], cursorPos.lane);\r\n          }\r\n        } else {\r\n          addTrackNotes(cursorPos.track, [cursorPos.timePos]);\r\n        }\r\n      } else {\r\n        const trackLane = xToTrackLane(x);\r\n        if (trackLane !== null) edit.setSelectedTrack(trackLane);\r\n      }\r\n    } else if (e.button === 2) { // 右クリック\r\n      if (cursorPos) {\r\n        if (cursorPos.isKey) {\r\n          if (cursorPos.note) deleteKeyNotes([cursorPos.note.id]);\r\n        } else {\r\n          if (cursorPos.note) deleteTrackNotes(cursorPos.track, [cursorPos.note.id]);\r\n        }\r\n      }\r\n    }\r\n\r\n  }\r\n\r\n  function handleMouseUp(e: React.MouseEvent<HTMLDivElement, MouseEvent>) {\r\n    if (e.button === 0) {\r\n      setApplyingTool(null);\r\n    }\r\n  }\r\n\r\n  function handleDrag(buttons: number, newMousePosition: Point2D | null, newScroll: Point2D) {\r\n    if (applyingTool) {\r\n      if (!newMousePosition) return;\r\n      const x = newMousePosition.x + newScroll.x;\r\n\r\n      const ret = computeNearestNote(trackNotesList[edit.selectedTrack], newMousePosition.y + newScroll.y, edit.verticalZoom);\r\n      if (!ret) return;\r\n      const note = ret[0];\r\n\r\n      const startX = keyLaneToX(applyingTool.lane);\r\n      const direction = (x < startX - 1) ? -1 : (startX - 1 + LANE_WIDTH <= x) ? 1 : 0;\r\n\r\n      switch (edit.selectedTool) {\r\n        case Tool.Stairs:\r\n          return applyStairs(edit.selectedTrack, applyingTool.timePos, note.timePos, applyingTool.lane, direction);\r\n        case Tool.MonoStairs:\r\n          return applyMonoStairs(edit.selectedTrack, applyingTool.timePos, note.timePos, applyingTool.lane, direction);\r\n        case Tool.Trill:\r\n          {\r\n            const keyLane = xToKeyLane(newMousePosition.x + newScroll.x);\r\n            if (keyLane === null) return;\r\n            return applyTrill(edit.selectedTrack, applyingTool.timePos, note.timePos, [applyingTool.lane, keyLane]);\r\n          }\r\n        default:\r\n          return setApplyingTool(null);\r\n      }\r\n\r\n    } else {\r\n      if (mousePosition && newMousePosition) {\r\n        const keyLane = xToKeyLane(newMousePosition.x + newScroll.x);\r\n        const trackLane = xToTrackLane(newMousePosition.x + newScroll.x);\r\n\r\n        if (keyLane !== null) {\r\n          // 開始地点、終了地点それぞれについて、スナップできるトラックノートがあればその地点を使い、\r\n          // なければマウスの地点を使う\r\n          const ret1 = computeNearestNote(trackNotesList[edit.selectedTrack], mousePosition.y + scroll.y, edit.verticalZoom);\r\n          const ret2 = computeNearestNote(trackNotesList[edit.selectedTrack], newMousePosition.y + newScroll.y, edit.verticalZoom);\r\n\r\n          if (ret1 && ret2) {\r\n            const [note1, dist1] = ret1;\r\n            const [note2, dist2] = ret2;\r\n\r\n            const p1 = (dist1 <= SNAP_DISTANCE) ? note1.timePos : yToTimePos(mousePosition.y + scroll.y, edit.verticalZoom);\r\n            const p2 = (dist2 <= SNAP_DISTANCE) ? note2.timePos : yToTimePos(newMousePosition.y + newScroll.y, edit.verticalZoom);\r\n\r\n            const [from, to] = [p1, p2].sort((a, b) => math.compare(a, b) as number);\r\n\r\n            if (edit.selectedTool === Tool.Paint && (buttons & 1) !== 0) {\r\n              addKeyNotesRange(edit.selectedTrack, from, to, keyLane);\r\n            } else if ((buttons & 2) !== 0) {\r\n              deleteKeyNotesRange(edit.selectedTrack, from, to, keyLane);\r\n            }\r\n          }\r\n        } else if (trackLane !== null) {\r\n          if (ctrlPressed) {\r\n            const p1 = math.chain(yToTimePos(mousePosition.y + scroll.y, edit.verticalZoom))\r\n              .multiply(GRID_EDIT_DIV).floor().divide(GRID_EDIT_DIV).done() as Fraction;\r\n            const p2 = math.chain(yToTimePos(newMousePosition.y + newScroll.y, edit.verticalZoom))\r\n              .multiply(GRID_EDIT_DIV).floor().divide(GRID_EDIT_DIV).done() as Fraction;\r\n\r\n            const [from, to] = [p1, p2].sort((a, b) => math.compare(a, b) as number);\r\n\r\n            if (edit.selectedTool === Tool.Paint && (buttons & 1) !== 0) {\r\n              addTrackNotesRange(trackLane, from, to);\r\n            } else if ((buttons & 2) !== 0) {\r\n              deleteTrackNotesRange(trackLane, from, to);\r\n            }\r\n          } else {\r\n            if ((buttons & 1) !== 0) {\r\n              edit.setSelectedTrack(trackLane);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  function handleMouseMove(e: React.MouseEvent<HTMLDivElement, MouseEvent>) {\r\n    e.stopPropagation();\r\n\r\n    const rect = e.currentTarget.getBoundingClientRect();\r\n    const newMousePosition = { x: e.clientX - rect.left, y: e.clientY - rect.top };\r\n\r\n    handleDrag(e.buttons, newMousePosition, scroll);\r\n\r\n    setMousePosition(newMousePosition);\r\n  }\r\n\r\n  function handleMouseOut(e: React.MouseEvent<HTMLDivElement, MouseEvent>) {\r\n    e.stopPropagation();\r\n\r\n    setMousePosition(null);\r\n  }\r\n\r\n  function handleWheel(e: React.WheelEvent<HTMLDivElement>) {\r\n    if (e.shiftKey && !applyingTool) {\r\n      e.preventDefault();\r\n\r\n      if (e.deltaY < 0) edit.setSelectedTrack((edit.selectedTrack + NUM_TRACKS - 1) % NUM_TRACKS);\r\n      else if (e.deltaY > 0) edit.setSelectedTrack((edit.selectedTrack + 1) % NUM_TRACKS);\r\n\r\n    } else if (e.ctrlKey) {\r\n      e.preventDefault();\r\n\r\n      if (e.deltaY < 0) edit.setVerticalZoom(edit.verticalZoom + ZOOM_STEP);\r\n      else if (e.deltaY > 0 && edit.verticalZoom > ZOOM_STEP) edit.setVerticalZoom(edit.verticalZoom - ZOOM_STEP);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"Sequence\" ref={panel}\r\n      onScroll={handleScroll}\r\n      onWheel={handleWheel}\r\n      onMouseDown={handleMouseDown}\r\n      onMouseUp={handleMouseUp}\r\n      onMouseMove={handleMouseMove}\r\n      onMouseOut={handleMouseOut}>\r\n\r\n      <div className=\"area\"\r\n        style={{\r\n          width: trackLaneInfo[trackLaneInfo.length - 1].left + LANE_WIDTH,\r\n          height: GRID_MEASURE_LEN * NUM_MEASURE * edit.verticalZoom\r\n        }}>\r\n\r\n        <div>\r\n          {keyLaneInfo.map((lane, i) =>\r\n            <LaneComponent key={i}\r\n              {...lane}\r\n              selected={false} />\r\n          )}\r\n          {trackLaneInfo.map((lane, i) =>\r\n            <LaneComponent key={i}\r\n              {...lane}\r\n              selected={edit.selectedTrack === i} />\r\n          )}\r\n        </div>\r\n\r\n        <HorizontalGrids panelScrollY={scroll.y}\r\n          panelHeight={panelSize.height} />\r\n\r\n        <Notes notes={keyNotes}\r\n          selectedTrack={edit.selectedTrack}\r\n          panelScrollY={scroll.y}\r\n          panelHeight={panelSize.height} />\r\n\r\n        {trackNotesList.map((notes, i) =>\r\n          <Notes key={i} notes={notes}\r\n            selectedTrack={edit.selectedTrack}\r\n            panelScrollY={scroll.y}\r\n            panelHeight={panelSize.height} />\r\n        )}\r\n\r\n        {cursorPos &&\r\n          <CursorNote position={cursorPos} />\r\n        }\r\n\r\n      </div>\r\n\r\n    </div>\r\n  );\r\n});\r\n","import React, { useEffect } from 'react';\r\nimport classNames from 'classnames';\r\nimport iconSelect from '../icons/tool_select.png';\r\nimport iconWrite from '../icons/tool_write.png';\r\nimport iconPaint from '../icons/tool_paint.png';\r\nimport iconErase from '../icons/tool_erase.png';\r\nimport iconKeyInput from '../icons/tool_keyInput.png';\r\nimport iconStairs from '../icons/tool_stairs.png';\r\nimport iconMonoStairs from '../icons/tool_monoStairs.png';\r\nimport iconTrill from '../icons/tool_trill.png';\r\nimport iconPattern from '../icons/tool_pattern.png';\r\nimport { Tool } from '../store/types';\r\nimport { SequenceContainer } from '../store/SequenceContainer';\r\n\r\ninterface ToolIcon {\r\n  enabled: boolean;\r\n  icon: string;\r\n  label: string;\r\n}\r\n\r\nconst icons: ToolIcon[] = [\r\n  { enabled: false, icon: iconSelect, label: \"選択ツール\" },\r\n  { enabled: false, icon: iconWrite, label: \"鉛筆ツール\" },\r\n  { enabled: true, icon: iconPaint, label: \"ペイントツール\" },\r\n  { enabled: false, icon: iconErase, label: \"消しゴムツール\" },\r\n  { enabled: false, icon: iconKeyInput, label: \"キー入力ツール\" },\r\n  { enabled: true, icon: iconStairs, label: \"階段ツール\" },\r\n  { enabled: true, icon: iconMonoStairs, label: \"同色階段ツール\" },\r\n  { enabled: true, icon: iconTrill, label: \"トリルツール\" },\r\n  { enabled: false, icon: iconPattern, label: \"パターンツール\" },\r\n];\r\n\r\nfunction createTool(icon: ToolIcon, tool: Tool, selected: boolean,\r\n  setSelectedTool: (value: number) => void) {\r\n\r\n  return (\r\n    <li className={classNames(\r\n      selected ? 'selected' : '',\r\n      icon.enabled ? '' : 'disabled'\r\n    )}\r\n      key={tool} onClick={() => setSelectedTool(tool)}\r\n    >\r\n      <img src={icon.icon} alt={icon.label} />\r\n    </li>\r\n  );\r\n}\r\n\r\nconst KEYCODE_1 = 49;\r\n\r\nexport const ToolBar: React.FC = props => {\r\n  const { edit, clearAll, clearKey } = SequenceContainer.useContainer();\r\n\r\n  // 数字キーでツールを選択\r\n  useEffect(() => {\r\n    function handleKeyDown(e: KeyboardEvent) {\r\n      const i = e.keyCode - KEYCODE_1;\r\n      if (0 <= i && i <= Tool.Pattern) {\r\n        edit.setSelectedTool(i);\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n      }\r\n    }\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => window.removeEventListener('keydown', handleKeyDown);\r\n  }, [edit]);\r\n\r\n  const vz = edit.verticalZoom;\r\n\r\n  return (\r\n    <div className=\"ToolBar\">\r\n      <ul className=\"tools\">\r\n        {icons.map((icon, tool) => createTool(icon, tool, tool === edit.selectedTool, edit.setSelectedTool))}\r\n      </ul>\r\n      <div className=\"buttons\">\r\n        Zoom: x{Math.floor(vz)}.{Math.floor(vz * 10 % 10)}{Math.floor(vz * 100 % 10)}\r\n        <input type=\"range\" value={edit.verticalZoom} min=\"0.25\" max=\"5\" step=\"0.25\" style={{ position: 'absolute', left: 90, top: 7 }}\r\n          onChange={e => edit.setVerticalZoom(Number.parseFloat(e.currentTarget.value))}></input>\r\n        <span style={{ position: 'absolute', left: 300, top: 0, width: 200 }}>\r\n          <button onClick={() => clearKey()}>Clear Key</button>\r\n          <button onClick={() => clearAll()}>Clear All</button>\r\n        </span>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport './index.css';\r\nimport { App } from './components/App';\r\nimport * as serviceWorker from './serviceWorker';\r\nimport { EditContainer } from './store/EditContainer';\r\nimport { SequenceContainer } from './store/SequenceContainer';\r\n\r\nReactDOM.render(\r\n  <EditContainer.Provider>\r\n    <SequenceContainer.Provider>\r\n      <App />\r\n    </SequenceContainer.Provider>\r\n  </EditContainer.Provider>,\r\n  document.getElementById('root')\r\n);\r\n\r\n// If you want your app to work offline and load faster, you can change\r\n// unregister() to register() below. Note this comes with some pitfalls.\r\n// Learn more about service workers: https://bit.ly/CRA-PWA\r\nserviceWorker.unregister();\r\n","import React from 'react';\r\nimport './App.css';\r\nimport { Sequence } from './Sequence';\r\nimport { ToolBar } from './ToolBar';\r\n\r\nexport const App: React.FC = () => {\r\n  return (\r\n    <div className=\"App\"\r\n      onContextMenu={e => e.preventDefault()}\r\n      onDragStart={e => e.preventDefault()}\r\n      onWheel={e => e.ctrlKey && e.preventDefault()}\r\n    >\r\n      <ToolBar />\r\n      <Sequence />\r\n    </div>\r\n  );\r\n}\r\n"],"sourceRoot":""}